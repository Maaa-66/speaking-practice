<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Speaking Practice" />
  <title>Speaking Practice</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Nunito',sans-serif;background:#0f172a;display:flex;justify-content:center;min-height:100vh;-webkit-tap-highlight-color:transparent;}
    .shell{width:100%;max-width:430px;min-height:100vh;background:#f8fafc;display:flex;flex-direction:column;}
    .page{flex:1;padding:16px 16px 40px;display:flex;flex-direction:column;gap:12px;}
    .stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:4px 0;}
    .stat-card{background:white;border-radius:16px;padding:14px 10px;text-align:center;box-shadow:0 1px 8px rgba(0,0,0,0.06);}
    .ghost-btn{background:none;border:2px dashed #cbd5e0;border-radius:14px;color:#94a3b8;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;padding:12px;width:100%;cursor:pointer;margin-top:4px;}
    .fc-card{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);border-radius:24px;min-height:260px;padding:28px 22px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.2);flex:1;}
    .fc-front{display:flex;flex-direction:column;align-items:center;text-align:center;}
    .fc-num{font-size:11px;color:#6366f1;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px;}
    .fc-title{font-size:22px;font-weight:800;color:white;line-height:1.3;}
    .fc-hint{font-size:13px;color:#64748b;margin-top:24px;}
    .fc-back{display:flex;flex-direction:column;}
    .fc-text{font-size:14px;line-height:1.85;color:#e2e8f0;font-weight:600;}
    .tts-row{display:flex;gap:8px;}
    .tts-btn{flex:1;padding:12px 6px;border-radius:14px;border:2px solid #e2e8f0;background:white;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#4a5568;cursor:pointer;}
    .tts-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:transparent;color:white;flex:2;}
    .tts-stop{border-color:#fecaca;color:#dc2626;background:#fff5f5;flex:0.6;}
    .score-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .score-btn{padding:18px;border-radius:18px;border:none;font-family:'Nunito',sans-serif;font-size:16px;font-weight:800;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.12);}
    .score-btn.good{background:#16a34a;color:white;}
    .score-btn.bad{background:#dc2626;color:white;}
    .quiz-q-box{background:white;border-radius:20px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,0.08);}
    .quiz-q-text{font-size:16px;color:#1e293b;font-weight:700;line-height:1.65;font-style:italic;}
    .quiz-opt{width:100%;padding:16px 18px;border-radius:16px;border:2px solid #e2e8f0;background:white;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;color:#1e293b;text-align:left;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,0.05);margin-bottom:10px;display:block;}
    .quiz-opt.correct{border-color:#16a34a;background:#f0fdf4;color:#14532d;}
    .quiz-opt.wrong{border-color:#dc2626;background:#fef2f2;color:#7f1d1d;}
    .quiz-result{border-radius:14px;padding:14px 18px;font-size:15px;font-weight:800;text-align:center;margin-bottom:10px;}
    .quiz-result.ok{background:#f0fdf4;color:#15803d;}
    .quiz-result.ng{background:#fef2f2;color:#991b1b;}
    .next-btn{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border:none;border-radius:18px;padding:18px;width:100%;font-family:'Nunito',sans-serif;font-size:16px;font-weight:800;cursor:pointer;box-shadow:0 4px 16px rgba(99,102,241,0.4);}
    .pct-circle{width:130px;height:130px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 8px 24px rgba(99,102,241,0.4);}
    .speed-btn{flex:1;padding:8px 0;border-radius:10px;border:2px solid #e2e8f0;background:white;font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;color:#64748b;cursor:pointer;}
    .speed-btn.active{border-color:#6366f1;background:#6366f1;color:white;}
    .topbar-fill{height:100%;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:6px;transition:width 0.4s ease;}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const topics = [
  { id: 1, title: "Hobby (Photography)", text: "I'm really into photography. I've been doing this for about five years now. What I love about it is that it helps me see the world differently. I notice small details like light and shadows that I never paid attention to before. Taking photos is also a great way to keep memories of special moments. It's both creative and relaxing for me." },
  { id: 2, title: "Education", text: "I believe that the main purpose of education is to teach people how to think for themselves. In today's world, information is everywhere, so it's more important to know how to evaluate it than just to memorize facts. Education should also help students become responsible members of society. When people can think critically, they can make better decisions in their lives." },
  { id: 3, title: "A Person Who Inspires You", text: "The person who inspires me most is my late father. What made him special was that he worked very hard but was always kind to everyone. He treated all people with respect, whether they were rich or poor. He taught me that success isn't just about your job - it's also about how you treat others. His example shows that you can be both hardworking and caring at the same time." },
  { id: 4, title: "Environmental Issue", text: "I'm concerned about air pollution, especially in big cities. This affects people's health and can cause breathing problems. We can help by using public transportation or riding bicycles instead of driving cars. Planting more trees in cities is also helpful. The government should make stricter rules for factories and invest more in clean energy. Both individuals and governments need to work together on this." },
  { id: 5, title: "Cultural Custom (New Year)", text: "One important tradition in my country is New Year's Day, or Oshougatsu. We celebrate by cleaning our houses before the new year and preparing special foods called osechi. Each dish has a special meaning - for example, black beans represent health. On New Year's Day, families gather to eat together and visit shrines. This custom is meaningful because it brings families together and gives us time to think about the past year and our hopes for the future." },
  { id: 6, title: "Favorite Holiday", text: "My favorite holiday is New Year's Day. What makes it special is that it's a time for both celebration and reflection. I enjoy going to my mother's house with my family because we can spend quality time together. It gives me a chance to think about what I did last year and set goals for the new year. The combination of family, traditional food, and looking forward to the future makes it my favorite holiday." },
  { id: 7, title: "Friendship", text: "Friendship is important to me because true friends give honest advice, even when it's hard to hear. They help me see things from different perspectives when I face problems. I can be myself around them without worrying about being judged. Good friends also support me when I'm going through difficult times and celebrate with me when things go well. Having people who truly understand you makes life much better." },
  { id: 8, title: "Public Transportation vs. Driving", text: "There are advantages and disadvantages to both options. On one hand, public transportation is cheaper and better for the environment. You don't have to pay for gas, parking, or car maintenance. On the other hand, cars give you more freedom. You can go anywhere at any time without waiting for buses or trains. The main benefit of driving is convenience, but the downside is the cost and environmental impact. I think the best choice depends on where you live and what you need." },
  { id: 9, title: "Favorite Weather", text: "I prefer sunny weather because it makes me feel positive and energetic. When it's sunny, I can go for walks, take photos outside, or just enjoy my morning coffee on the balcony. Sunny weather puts me in a good mood and helps me be more productive. I also feel more motivated to exercise and spend time outdoors. Of course, I appreciate other types of weather too, but nothing beats a clear, sunny day for me." },
  { id: 10, title: "Dream Travel Destination", text: "If I could travel anywhere, I would go to Italy. I've always wanted to try authentic Italian food in its home country - not just pizza, but regional dishes from different areas. What attracts me most is the combination of food, history, and beautiful architecture. I'd love to experience places like Rome and Florence, where you can see ancient buildings and world-famous art. Italian culture also seems to value enjoying life, which I find appealing." },
  { id: 11, title: "Favorite Technology", text: "The technology I use most is my smartphone. It has changed my life by making communication so much easier. I can stay in touch with friends and family through messages and video calls. It also allows me to access information instantly - I can look up anything I need to know in seconds. I can't imagine living without it now. However, I try to be careful not to spend too much time looking at the screen." },
  { id: 12, title: "Historical Figure (Helen Keller)", text: "I admire Helen Keller because she overcame incredible challenges. Despite losing both her sight and hearing as a young child, she learned to communicate and became a famous writer and speaker. Her story teaches us that our limitations don't define what we can achieve. With determination and the right support, people can accomplish amazing things. She also spent her life helping others with disabilities, which makes her even more inspiring." },
  { id: 13, title: "Impactful Movie (Toy Story)", text: "A movie that really affected me was Toy Story. It's an animated film, but it has deep messages about friendship and loyalty. The message I took from it was that true friendship means accepting others and putting their needs alongside your own. I was moved by how the characters support each other through difficult times. It made me realize that good relationships require effort and understanding. Even though it's a children's movie, I think adults can learn a lot from it too." },
  { id: 14, title: "Skill to Learn (Medicinal Cooking)", text: "I'd like to learn medicinal cooking, which means using food to support health. I'm interested in this because food affects our bodies in many ways. This skill would help me take better care of my family by preparing meals that are both delicious and healthy. It would allow me to understand which foods are good for different conditions - like what to eat when you have a cold or feel tired. I think this knowledge could really improve our daily lives." },
  { id: 15, title: "Challenging Situation", text: "One of the most difficult times was when I got seriously ill last year. I had to stay in bed for a long time, which gave me time to think about my life. It made me realize that I had some regrets about not studying harder when I was younger. I learned from this experience that we shouldn't wait to do important things. After that, I decided to start taking online courses. The illness was hard, but it helped me understand what really matters to me." },
  { id: 16, title: "Passion for Reading", text: "I'm passionate about reading books. Reading helps me learn new things and understand different perspectives. Through books, I can experience stories and ideas from around the world without leaving my home. I try to read a variety of genres - both fiction and non-fiction - to keep learning and growing. Fiction develops my imagination and empathy, while non-fiction teaches me practical knowledge. It's a hobby that never gets boring because there's always something new to discover." },
  { id: 17, title: "Work Experience Lesson", text: "Through my work experience, I learned that being punctual and polite is extremely important. At first, I thought these were just basic rules. But I realized that arriving on time shows respect for other people's time. Being polite creates a positive working environment and builds trust with colleagues. This has helped me in my career because people see me as reliable. I've noticed that workers with good manners often get more opportunities than those who don't, even if their skills are similar." },
  { id: 18, title: "Favorite Dish (Ramen)", text: "My favorite dish is ramen. It consists of noodles in a rich broth, usually with sliced pork, egg, and green onions. What makes it special is that the broth takes many hours to prepare - some restaurants cook it for over 12 hours. It reminds me of good times with friends after school or work, sitting in a warm restaurant on a cold day. The taste is comforting, and each region of Japan has its own style. For me, ramen is not just food - it's connected to happy memories." },
  { id: 19, title: "Inspiring Book/Movie (Harry Potter)", text: "Harry Potter has influenced me greatly. The main lesson I took from it was that courage doesn't mean you're not afraid - it means doing the right thing even when you are scared. The characters in the story often feel fear, but they choose to act anyway. It showed me that everyone can be brave in their own way. I apply this to my own life by trying to face difficult situations instead of avoiding them. This series taught me that our choices matter more than our abilities." },
  { id: 20, title: "Difficult Decision (University)", text: "One of the hardest decisions I made was choosing my university major. I had to consider many things: what I'm interested in, job opportunities, and my future career. I was torn between following my passion and choosing something practical. In the end, I tried to find a balance between both. Looking back, I think the most important thing is to make a decision and commit to it fully. No choice is perfect, but we can make any path work if we put in the effort." },
  { id: 21, title: "Learning Languages", text: "Learning a new language is valuable because it opens doors to new cultures and opportunities. When you learn a language, you can better understand how people from that culture think and live. This builds empathy and breaks down barriers between people. In addition, it helps you in your career - many companies need employees who can speak multiple languages. English, in particular, connects people from almost every country. Learning languages also keeps your brain active and improves your memory. It's challenging, but the benefits are worth the effort." },
  { id: 22, title: "Personal Skill (Cooking)", text: "A skill I'm proud of is cooking. I developed this skill by practicing every day and learning from my mistakes. At first, I just followed recipes, but now I can adjust dishes based on what ingredients I have. I use it daily to prepare healthy meals for my family. It benefits my life by saving money compared to eating out and by giving me control over what we eat. Cooking has become more than just a necessity - it's a way to show care for the people I love and to express creativity." },
  { id: 23, title: "Favorite Place (Lake Kawaguchi)", text: "My favorite place to visit is Lake Kawaguchi, near Mount Fuji. What I love about it is the incredible view of the mountain reflected in the lake. It's beautiful because the scenery changes with each season - cherry blossoms in spring, colorful leaves in autumn. Going there helps me relax and forget about the stress of daily life. The peaceful atmosphere is very different from the busy city. Walking by the lake and enjoying nature reminds me of what's truly important and gives me energy to face my regular routine again." },
  { id: 24, title: "Technology in Society", text: "Technology has both benefits and drawbacks. On the positive side, it has made communication easier than ever. We can talk to anyone in the world instantly and access information about almost anything. However, we should be careful about privacy and spending too much time on screens. Many people now have less face-to-face interaction than before, which can affect relationships. The key is to use technology wisely - taking advantage of its benefits while maintaining real human connections and protecting our personal information." },
  { id: 25, title: "Environmental Conservation", text: "We need to protect the environment for future generations. Simple actions like reducing plastic use and saving water can make a difference. For example, we can bring our own bags when shopping and turn off the tap while brushing our teeth. Both individuals and governments must take responsibility - people should change their habits, and governments should create laws to protect nature. Future generations will benefit if we start taking action now. It's not too late, but we need to act quickly and consistently." },
  { id: 26, title: "Meeting a Historical Figure (Einstein)", text: "If I could meet anyone from history, I would choose Albert Einstein. I'm curious about how he came up with his revolutionary ideas. I would ask him about his thinking process - how he used imagination together with math and science. I think I could learn a lot from talking to him about creativity and not being afraid to question common beliefs. He also had interesting views on education and life in general. It would be amazing to understand how such a brilliant mind worked." },
  { id: 27, title: "Personal Achievement (Morning Reading)", text: "An achievement I'm proud of is building a habit of waking up at 4 AM to read English books. It was difficult at first because I'm not naturally a morning person. I succeeded by making some changes to my routine - going to bed earlier and preparing my books the night before. Now it feels natural, and I've improved my English a lot. This taught me that building good habits takes time and requires removing obstacles. You can't just rely on motivation - you need a good system." },
  { id: 28, title: "Adapting to New Environment", text: "When I moved to a new city, I found it challenging because I didn't know anyone there. At first, I felt lonely and homesick. Everything was unfamiliar, from the streets to the local customs. To adapt, I started talking to my neighbors and joining local groups based on my interests. Slowly, I made friends and the city began to feel like home. This experience taught me that adapting to new situations requires effort - you have to step out of your comfort zone and actively try to connect with people." },
  { id: 29, title: "Childhood Memory (Beach)", text: "One of my happiest childhood memories is a family trip to the beach. I remember the feeling of warm sand under my feet vividly. We built sandcastles, played in the waves, and had a picnic together. What made it special was not any exciting activity, but simply being together as a family without any rush or worry. When I think about it now, I realize that the best memories aren't about expensive trips or fancy things - they're about spending quality time with people you love." },
  { id: 30, title: "Fascinating Animal (Dolphins)", text: "An animal that fascinates me is the dolphin. What's amazing about them is their intelligence and social behavior. They are known for living in groups called pods, where they work together and care for each other. Scientists have found that dolphins can recognize themselves in mirrors, which shows they have self-awareness. They also seem to have their own names for each other. Dolphins can solve problems and even appear to play for fun, not just to learn. Their intelligence makes them one of the most interesting animals in the world." },
  { id: 31, title: "Daily Routine", text: "My typical day starts early - I wake up at 5 AM to have some quiet time before work. I use this time for personal goals like reading or studying. Then I work from 9 to 5, trying to stay focused and productive. After work, I usually do some household tasks and prepare dinner. I try to balance work responsibilities with personal growth activities. Before bed, I like to watch educational videos on YouTube. It's a relaxing way to end the day while still learning something new." },
  { id: 32, title: "Historical Event (Internet)", text: "One of the most important events in history is the creation of the Internet. It changed society by connecting people all over the world instantly. Before the Internet, people had to go to libraries for information or wait days for letters to arrive. Today, we can find almost any information in seconds and communicate with anyone anywhere. It has transformed business, education, and how we maintain relationships. Of course, it also brought new problems like privacy concerns, but overall, the Internet has made knowledge more accessible to everyone." },
  { id: 33, title: "School Memory (First Day)", text: "I clearly remember my first day of elementary school. I was nervous because everything was new - the building, the teachers, and all the other children. I didn't know anyone, and I worried about whether I would make friends. What helped me was meeting another nervous student. We were both shy, but somehow that made it easier to talk to each other. We became good friends that day. Looking back, this experience taught me that showing my true feelings can actually help me connect with others who feel the same way." },
  { id: 34, title: "Favorite Music Genre", text: "My favorite type of music is pop. It makes me feel happy and energetic. The catchy melodies and strong beats always lift my mood. I enjoy listening to it when I'm exercising or doing housework - it makes tasks feel easier and more enjoyable. Music has the power to change how we feel instantly. While I appreciate other genres too, pop music is what I turn to most often. It doesn't require deep concentration to enjoy, which makes it perfect for everyday activities." },
  { id: 35, title: "Technology Impact (Computer)", text: "The technology that has impacted me most is my computer. I use it for work, learning, and entertainment. It has made accessing information much easier - I can watch tutorial videos, take online courses, and research any topic I'm curious about. Without it, I couldn't do my job effectively or continue my education in the way I do now. The computer has become like a window to the world, connecting me to knowledge and people everywhere. It's amazing how one device can serve so many purposes." },
  { id: 36, title: "Memorable Dining Experience", text: "A memorable eating experience I had was trying rabbit for the first time in France. I was hesitant at first because in my culture, rabbits are seen more as pets than food. But I decided to try it as part of experiencing French culture. After trying it, I realized it actually tasted quite good - similar to chicken but more tender. This taught me to be more open-minded about food from different cultures. What seems strange to us might be completely normal somewhere else. Traveling and trying new things helps us understand this." },
  { id: 37, title: "Importance of Communication", text: "Communication is essential because it's how we share ideas, solve problems, and build relationships. Technology has made it easier to stay in touch with people far away through messages and video calls. However, we should remember that face-to-face conversation is still very important. When we meet in person, we can see facial expressions and body language, which helps us understand each other better. Good communication requires both speaking clearly and listening carefully. In today's world, we need to balance online and in-person communication." },
  { id: 38, title: "School Memory (Friends)", text: "A school memory I treasure is spending time with friends after class. We spent time singing karaoke and walking along the river, talking about our dreams and worries. What made it memorable was the feeling of freedom and connection - we could be ourselves completely without any judgment. We laughed, shared secrets, and supported each other. These moments remind me that simple times with good friends are often the happiest. Now that I'm older and busier, I appreciate those carefree days even more." },
  { id: 39, title: "Inspiring Book (The Little Prince)", text: "A book that changed my perspective is The Little Prince. Although it's written for children, its messages are very deep. The most important message is that what really matters in life is invisible - things like love, friendship, and the time we invest in relationships. It taught me that a relationship becomes special not because of what someone is, but because of the care and attention we give to them. I often think about this when I'm too focused on work or material things. The book reminds me to treasure the people in my life." },
  { id: 40, title: "Influential Teacher", text: "A person who influenced me greatly is one of my teachers. He encouraged me to never give up on my dreams, especially when I was going through a hard time. What I learned from him was that our current situation doesn't determine our future - we can always grow and improve with effort. He believed in me even when I didn't believe in myself. Thanks to him, I kept going and eventually found my own path. His faith in me changed how I see my own potential." },
];

function shuffle(arr) { return [...arr].sort(() => Math.random() - 0.5); }
function firstSentence(text) { const s = text.indexOf(". "); return s===-1 ? text : text.slice(0, s+1); }
const MODES = { HOME:"home", FLASHCARD:"flashcard", QUIZ:"quiz", RESULTS:"results" };

function useTTS() {
  const [speaking, setSpeaking] = useState(false);
  const rateRef = useRef(0.88);
  const speak = useCallback((text) => {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = "en-US"; utt.rate = rateRef.current; utt.pitch = 1.0;
    const voices = window.speechSynthesis.getVoices();
    const v = voices.find(v => v.lang.startsWith("en") && /samantha|karen|victoria|moira|fiona|zira|jenny/i.test(v.name))
      || voices.find(v => v.lang.startsWith("en-US"))
      || voices.find(v => v.lang.startsWith("en"));
    if (v) utt.voice = v;
    utt.onstart = () => setSpeaking(true);
    utt.onend = () => setSpeaking(false);
    utt.onerror = () => setSpeaking(false);
    window.speechSynthesis.speak(utt);
  }, []);
  const stop = useCallback(() => { window.speechSynthesis && window.speechSynthesis.cancel(); setSpeaking(false); }, []);
  useEffect(() => () => window.speechSynthesis && window.speechSynthesis.cancel(), []);
  return { speak, stop, speaking, rateRef };
}

function App() {
  const [mode, setMode] = useState(MODES.HOME);
  const [deck, setDeck] = useState([]);
  const [idx, setIdx] = useState(0);
  const [flipped, setFlipped] = useState(false);
  const [scores, setScores] = useState({});
  const [quizOrder, setQuizOrder] = useState([]);
  const [options, setOptions] = useState([]);
  const [quizAnswered, setQuizAnswered] = useState(false);
  const [selected, setSelected] = useState(null);
  const [speed, setSpeed] = useState(0.88);
  const { speak, stop, speaking, rateRef } = useTTS();

  useEffect(() => { rateRef.current = speed; }, [speed]);

  const known = Object.entries(scores).filter(([,v])=>v==="known").map(([k])=>+k);
  const unknown = Object.entries(scores).filter(([,v])=>v==="unknown").map(([k])=>+k);

  const startFC = (filter) => {
    stop();
    const d = filter==="unknown" ? topics.filter(t=>!known.includes(t.id)) : topics;
    setDeck(shuffle(d)); setIdx(0); setFlipped(false); setMode(MODES.FLASHCARD);
  };

  const startQuiz = () => {
    stop();
    setQuizOrder(shuffle(topics)); setIdx(0); setQuizAnswered(false); setSelected(null); setMode(MODES.QUIZ);
  };

  useEffect(() => {
    if (mode===MODES.QUIZ && quizOrder.length>0) {
      const c = quizOrder[idx];
      setOptions(shuffle([c, ...shuffle(topics.filter(t=>t.id!==c.id)).slice(0,3)]));
    }
  }, [mode, quizOrder, idx]);

  const card = deck[idx];
  const quiz = quizOrder[idx];

  const handleFC = (res) => {
    stop();
    setScores(p=>({...p,[card.id]:res}));
    if (idx+1>=deck.length) setMode(MODES.RESULTS);
    else { setIdx(i=>i+1); setFlipped(false); }
  };

  const handleQuizAnswer = (opt) => {
    setSelected(opt); setQuizAnswered(true);
    setScores(p=>({...p,[quiz.id]: opt.id===quiz.id?"known":"unknown"}));
    if (opt.id===quiz.id) speak(quiz.text);
  };

  const nextQuiz = () => {
    stop();
    if (idx+1>=quizOrder.length) setMode(MODES.RESULTS);
    else { setIdx(i=>i+1); setQuizAnswered(false); setSelected(null); }
  };

  const knownCt = known.length, unknownCt = unknown.length;
  const answered = Object.keys(scores).length;
  const pct = answered>0 ? Math.round((knownCt/answered)*100) : 0;
  const fcProg = deck.length>0 ? (idx/deck.length)*100 : 0;
  const qProg = quizOrder.length>0 ? (idx/quizOrder.length)*100 : 0;

  const SpeedBar = () => (
    <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
      <span style={{fontSize:11,color:"#94a3b8",fontWeight:700,flexShrink:0}}>ã‚¹ãƒ”ãƒ¼ãƒ‰</span>
      {[["ğŸ¢ é…ã„",0.7],["ğŸ‡ æ™®é€š",0.88],["âš¡ é€Ÿã„",1.1]].map(([l,v])=>(
        <button key={v} onClick={()=>setSpeed(v)} className={"speed-btn"+(speed===v?" active":"")}>{l}</button>
      ))}
    </div>
  );

  const TopBar = ({prog,cur,tot}) => (
    <div style={{display:"flex",alignItems:"center",gap:12,paddingBottom:8}}>
      <button onClick={()=>{stop();setMode(MODES.HOME);}} style={{background:"white",border:"none",borderRadius:12,width:40,height:40,fontSize:18,cursor:"pointer",boxShadow:"0 1px 6px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>â†</button>
      <div style={{flex:1}}>
        <div style={{background:"#e2e8f0",height:6,borderRadius:6,overflow:"hidden",marginBottom:4}}>
          <div className="topbar-fill" style={{width:`${prog}%`}} />
        </div>
        <span style={{fontSize:11,color:"#94a3b8",fontWeight:700}}>{cur} / {tot}</span>
      </div>
    </div>
  );

  return (
    <div className="shell">
      {mode===MODES.HOME && (
        <div className="page">
          <div style={{textAlign:"center",padding:"28px 0 12px"}}>
            <div style={{fontSize:52,marginBottom:8}}>ğŸ™ï¸</div>
            <h1 style={{fontSize:26,fontWeight:800,color:"#0f172a"}}>Speaking Practice</h1>
            <p style={{fontSize:13,color:"#94a3b8",marginTop:4,fontWeight:600}}>40 Topics Â· Eiken Pre-1</p>
          </div>
          <div className="stat-row">
            {[[topics.length,"å…¨ãƒˆãƒ”ãƒƒã‚¯","#4a5568"],[knownCt,"è¦šãˆãŸ âœ“","#16a34a"],[unknownCt,"è¦å¾©ç¿’","#dc2626"]].map(([n,l,c])=>(
              <div key={l} className="stat-card">
                <div style={{fontSize:30,fontWeight:800,color:c}}>{n}</div>
                <div style={{fontSize:11,color:"#94a3b8",fontWeight:700,marginTop:3}}>{l}</div>
              </div>
            ))}
          </div>
          <p style={{fontSize:11,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:1}}>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</p>
          <BigBtn icon="ğŸƒ" label="å…¨ã¦ç·´ç¿’ã™ã‚‹" sub="40ãƒˆãƒ”ãƒƒã‚¯å…¨éƒ¨" bg="#1e293b" onClick={()=>startFC("all")} />
          {unknownCt>0 && <BigBtn icon="ğŸ”" label={`è‹¦æ‰‹ã ã‘ (${unknownCt}ä»¶)`} sub="ã¾ã è¦šãˆã¦ã„ãªã„ã‚‚ã®ã‚’é›†ä¸­ç·´ç¿’" bg="#b91c1c" onClick={()=>startFC("unknown")} />}
          <p style={{fontSize:11,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:1,marginTop:8}}>ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰</p>
          <BigBtn icon="â“" label="4æŠã‚¯ã‚¤ã‚º" sub="æœ€åˆã®1æ–‡ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‚’å½“ã¦ã‚‹" bg="#0f766e" onClick={startQuiz} />
          {knownCt>0 && <button className="ghost-btn" onClick={()=>setScores({})}>ğŸ”„ è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>}
        </div>
      )}

      {mode===MODES.FLASHCARD && card && (
        <div className="page">
          <TopBar prog={fcProg} cur={idx+1} tot={deck.length} />
          <SpeedBar />
          <div className="fc-card" onClick={()=>!flipped && setFlipped(true)}>
            {!flipped ? (
              <div className="fc-front">
                <div className="fc-num">Topic #{card.id}</div>
                <div className="fc-title">{card.title}</div>
                <div className="fc-hint">å£°ã«å‡ºã—ã¦è©±ã—ãŸã‚‰ã€ã‚¿ãƒƒãƒ— â†’</div>
              </div>
            ) : (
              <div className="fc-back">
                <div style={{fontSize:11,color:"#6366f1",fontWeight:700,marginBottom:10,textTransform:"uppercase",letterSpacing:1}}>{card.title}</div>
                <p className="fc-text">{card.text}</p>
              </div>
            )}
          </div>
          <div className="tts-row">
            <button className="tts-btn" onClick={()=>speak(firstSentence(card.text))}>â–¶ æœ€åˆã®1æ–‡</button>
            <button className="tts-btn tts-primary" onClick={()=>speak(card.text)}>{speaking?"ğŸ”Š å†ç”Ÿä¸­":"â–¶ å…¨æ–‡ã‚’èª­ã‚€"}</button>
            <button className="tts-btn tts-stop" onClick={stop}>â¹</button>
          </div>
          {flipped ? (
            <div className="score-row">
              <button className="score-btn bad" onClick={()=>handleFC("unknown")}>ğŸ˜“ ã‚‚ã†ä¸€åº¦</button>
              <button className="score-btn good" onClick={()=>handleFC("known")}>âœ“ è¦šãˆãŸï¼</button>
            </div>
          ) : (
            <p style={{textAlign:"center",fontSize:12,color:"#94a3b8",fontWeight:600}}>ç­”ãˆã‚’ç¢ºèªã—ãŸã‚‰ã€Œè¦šãˆãŸã€ã‹ã€Œã‚‚ã†ä¸€åº¦ã€ã‚’é¸ã‚“ã§ãã ã•ã„</p>
          )}
        </div>
      )}

      {mode===MODES.QUIZ && quiz && (
        <div className="page">
          <TopBar prog={qProg} cur={idx+1} tot={quizOrder.length} />
          <SpeedBar />
          <div className="quiz-q-box">
            <p style={{fontSize:10,color:"#94a3b8",fontWeight:700,textTransform:"uppercase",letterSpacing:1,marginBottom:8}}>ã“ã®ã‚¹ãƒ”ãƒ¼ãƒã¯ã©ã®ãƒˆãƒ”ãƒƒã‚¯ï¼Ÿ</p>
            <p className="quiz-q-text">"{firstSentence(quiz.text)}"</p>
            <div className="tts-row" style={{marginTop:12}}>
              <button className="tts-btn tts-primary" onClick={()=>speak(quiz.text)}>{speaking?"ğŸ”Š å†ç”Ÿä¸­":"â–¶ å…¨æ–‡ã‚’èã"}</button>
              <button className="tts-btn tts-stop" onClick={stop}>â¹</button>
            </div>
          </div>
          <div>
            {options.map(opt=>{
              let cls="quiz-opt";
              if(quizAnswered){ if(opt.id===quiz.id) cls+=" correct"; else if(opt.id===selected?.id) cls+=" wrong"; }
              return <button key={opt.id} className={cls} onClick={()=>!quizAnswered&&handleQuizAnswer(opt)}>{opt.title}</button>;
            })}
          </div>
          {quizAnswered && (
            <>
              <div className={"quiz-result "+(selected?.id===quiz.id?"ok":"ng")}>
                {selected?.id===quiz.id?"âœ“ æ­£è§£ï¼":`âœ— æ­£è§£ã¯ã€Œ${quiz.title}ã€`}
              </div>
              <button className="next-btn" onClick={nextQuiz}>
                {idx+1>=quizOrder.length?"çµæœã‚’è¦‹ã‚‹ â†’":"æ¬¡ã®å•é¡Œ â†’"}
              </button>
            </>
          )}
        </div>
      )}

      {mode===MODES.RESULTS && (
        <div className="page" style={{alignItems:"center"}}>
          <div style={{textAlign:"center",padding:"28px 0 16px"}}>
            <div className="pct-circle">
              <span style={{fontSize:36,fontWeight:800,color:"white"}}>{pct}%</span>
              <span style={{fontSize:12,color:"rgba(255,255,255,0.7)",fontWeight:700}}>æ­£è§£ç‡</span>
            </div>
            <h2 style={{fontSize:26,fontWeight:800,color:"#1e293b",marginTop:16}}>
              {pct>=80?"ã™ã”ã„ï¼ğŸ‰":pct>=50?"ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼":"ã‚‚ã†å°‘ã—ï¼ğŸ’ª"}
            </h2>
            <p style={{fontSize:14,color:"#94a3b8",fontWeight:700,marginTop:6}}>è¦šãˆãŸ {knownCt}ä»¶ ï¼ è¦å¾©ç¿’ {unknownCt}ä»¶</p>
          </div>
          <div style={{width:"100%",display:"flex",flexDirection:"column",gap:10}}>
            {unknownCt>0 && <BigBtn icon="ğŸ”" label={`è‹¦æ‰‹ã‚’å†ç·´ç¿’ (${unknownCt}ä»¶)`} bg="#b91c1c" onClick={()=>startFC("unknown")} />}
            <BigBtn icon="â“" label="ã‚¯ã‚¤ã‚ºã‚’ã‚‚ã†ä¸€åº¦" bg="#0f766e" onClick={startQuiz} />
            <BigBtn icon="ğŸ " label="ãƒ›ãƒ¼ãƒ ã¸" bg="#1e293b" onClick={()=>setMode(MODES.HOME)} />
          </div>
        </div>
      )}
    </div>
  );
}

function BigBtn({icon,label,sub,bg,onClick}) {
  return (
    <button onClick={onClick} style={{width:"100%",background:bg,border:"none",borderRadius:18,padding:"16px 18px",display:"flex",alignItems:"center",gap:14,cursor:"pointer",color:"white",boxShadow:"0 4px 14px rgba(0,0,0,0.2)",marginBottom:2}}>
      <span style={{fontSize:24,flexShrink:0}}>{icon}</span>
      <span style={{display:"flex",flexDirection:"column",alignItems:"flex-start"}}>
        <span style={{fontSize:16,fontWeight:800,fontFamily:"Nunito,sans-serif"}}>{label}</span>
        {sub && <span style={{fontSize:12,opacity:0.7,marginTop:2,fontFamily:"Nunito,sans-serif"}}>{sub}</span>}
      </span>
    </button>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
